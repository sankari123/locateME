<!DOCTYPE html>
<html>
<script src="https://maps.googleapis.com/maps/api/js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="cordova.js"></script>
<script>


		var x,y;
		var flg;
	    var return_data;
		var locArr;
		var tmpDat1;
		var latR;
		var result;
		var zoom;
		var multiArr = [];
		document.addEventListener("deviceready",onDeviceReady,false);
		
		function onDeviceReady()
		{
		
    	document.addEventListener("backbutton", function (e) {
        e.preventDefault(); 
		navigator.notification.confirm("Do you want to exit DIVE?", onConfirmExit, "DIVE", "Yes,No");   }, false );
		}

		function getLoc()
		{
		if (navigator.geolocation)
        {
           navigator.geolocation.getCurrentPosition(myMap);
        }
        else
        {
           alert("Geolocation API not supported.");
        }
	}
function myMap(position) {
       x = position.coords.latitude;
        y = position.coords.longitude;
  var myCenter = new google.maps.LatLng(x,y);
  var mapCanvas = document.getElementById("map");
  var mapOptions = {center: myCenter, zoom: 18};
  var map = new google.maps.Map(mapCanvas, mapOptions);
  var marker = new google.maps.Marker({position:myCenter});
  var infowindow = new google.maps.InfoWindow();
  marker.setMap(map);
}


function ajaxFunction(){
			zoom=14;
         var hr=new XMLHttpRequest();
		 var url="passVar1.php";
		 var queryString = "lat1=" + x +"&long11=" + y;
		
         hr.open("POST",url,true);
		hr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		hr.onreadystatechange=function(){
		if(hr.readyState==4 && hr.status==200)
		{
			return_data=hr.responseText;
			//document.getElementById("ajaxDiv").innerHTML=return_data;
			document.getElementById('rest1').value=return_data;
			procVal();
		}
		
		}
		hr.send(queryString);
 }
 
 function procVal(){
	if(document.getElementById("rest1").value.length==0)
	{
	}
	else
	{
		flg='y';
		//alert("Searching DIVE Joints");
		locArr = document.getElementById("rest1").value;
		locArr = locArr.substring(0, locArr.length - 1);
		locArr=locArr.split('#');
		tmpDat1='';

		for (var i = 0, len = locArr.length; i < len; i++) {
		delimiter = ',';
		start = 2;
		result = locArr[i].split(delimiter, start+1).join(delimiter);
		latR=result.split(',');
		tmpDat1 +="&markers=" +latR[0]+","+latR[1]+","+latR[2];
		
		
		var radlat1 = Math.PI * x/180;
	    var radlat2 = Math.PI * latR[0]/180;
		var theta = y-latR[1];
		var radtheta = Math.PI * theta/180;
		var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
		dist = Math.acos(dist);
	    dist = dist * 180/Math.PI;
		dist = dist * 60 * 1.1515;
	//  alert(dist+"___"+i);
	  //alert(len);
	multiArr.push([latR[2],latR[0],latR[1],dist]);
		
		}
		document.getElementById("tmpD").value=tmpDat1;
		//navigator.geolocation.getCurrentPosition(handle_geolocation_query);
		displayArr();
		
		
	}	
	
	
}

function displayArr()
{
for (var i = 0, len = multiArr.length; i < len; i++) {
//alert(multiArr[i],multiArr[i],multiArr[i],multiArr[i]);
}
 var map1 = new google.maps.Map(document.getElementById('map'), {
      zoom: 16,
      center: new google.maps.LatLng(x,y),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });

   var infowindow = new google.maps.InfoWindow();

    var marker, i;

    for (i = 0; i < multiArr.length; i++) { 
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(multiArr[i][1], multiArr[i][2]),
        map: map1
      });

      google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
          infowindow.setContent(multiArr[i][0]);
          infowindow.open(map1, marker);
        }
      })(marker, i));
    }
	
	
}
function distance(lat1, lon1, lat2, lon2, unit) {
	var radlat1 = Math.PI * lat1/180
	var radlat2 = Math.PI * lat2/180
	var theta = lon1-lon2
	var radtheta = Math.PI * theta/180
	var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
	dist = Math.acos(dist)
	dist = dist * 180/Math.PI
	dist = dist * 60 * 1.1515
	if (unit=="K") { dist = dist * 1.609344 }
	if (unit=="N") { dist = dist * 0.8684 }
	//return dist
}


</script>
<body onload="getLoc();">
<input type="button" value="LIST" onclick="ajaxFunction();" /><input type="button" value="MAP" id="mapItm" onclick="showMenu();" />
<div id='ajaxDiv' class="hideDontTakeUpSpace">Your result will display here</div>
<textarea id="tmpD"   rows=6 cols=50></textarea>
<textarea id="rest1" rows=6 cols=50></textarea>
<div id="map" style="width:100%;height:500px"></div>

</body>
</html>
